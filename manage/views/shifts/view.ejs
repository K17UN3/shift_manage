<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= currentMonth.format('YYYY年MM月') %> シフトカレンダー</title>
    <link rel="stylesheet" href="/css/stylesheet.css"> 
</head>
<body>

<div class="container">
    <div class="header-area">
        <h1><%= currentMonth.format('YYYY年MM月') %> シフト確認</h1>
        <div class="nav-links">
            <a href="/shifts/home">← ホームに戻る</a>
        </div>
    </div>

    <div class="calendar-grid">
        <div class="day-header sun">日</div>
        <div class="day-header">月</div>
        <div class="day-header">火</div>
        <div class="day-header">水</div>
        <div class="day-header">木</div>
        <div class="day-header">金</div>
        <div class="day-header sat">土</div>

        <% 
            let date = calendarStartDay.clone();
            while (date.isSameOrBefore(calendarEndDay, 'day')) {
                const dateString = date.format('YYYY-MM-DD');
                const yesterdayString = date.clone().subtract(1, 'day').format('YYYY-MM-DD');

                // --- この日に表示すべきシフトを抽出 ---
                let todayShifts = shiftsByDay[dateString] || [];

                let fromYesterday = (shiftsByDay[yesterdayString] || []).filter(s => s.end_time < s.start_time);

                let allDisplayShifts = [
                    ...todayShifts,
                    ...fromYesterday.map(s => ({ ...s, isContinued: true }))
                ];
        %>
        <a href="/shifts/day/<%= dateString %>" 
        class="day-cell <%= !date.isSame(currentMonth, 'month') ? 'outside' : '' %> <%= date.isSame(today, 'day') ? 'today' : '' %>">
            
            <span class="date-num"><%= date.date() %></span>
            
            <div class="shift-info">
                <% if (allDisplayShifts.length > 0) { %>
                    <div class="shift-count"><%= allDisplayShifts.length %>名</div>
                    <% allDisplayShifts.slice(0, 3).forEach(shift => { %>
                        <span class="shift-tag <%= shift.isContinued ? 'continued' : '' %>">
                            <% if (shift.isContinued) { %>
                                〜<%= shift.username %>
                            <% } else if (shift.end_time < shift.start_time) { %>
                                <%= shift.username %>〜
                            <% } else { %>
                                <%= shift.username %>
                            <% } %>
                        </span>
                    <% }); %>
                <% } %>
            </div>
        </a>
        <%
                date.add(1, 'day');
            }
        %>
    </div>
</div>

</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title><%= date %> のシフト表</title>
    <link rel="stylesheet" href="/css/stylesheet.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <a href="/shifts/view" class="nav-link">← 戻る</a>
                <h1><%= moment(date).format('M/D (ddd)') %> の詳細</h1>
            </div>
            <div id="breakToggle" class="toggle-btn" style="cursor: pointer; font-size: 0.8rem; color: #007bff;">
                休憩を表示する
            </div>
        </div>

        <div class="time-axis">
            <div class="time-axis-spacer"></div>
            <div class="time-labels">
                <% for(let i=0; i<=24; i+=2) { %>
                    <div class="time-label" style="grid-column-start: <%= i + 1 %>;">
                        <%= i %>:00
                    </div>
                <% } %>
            </div>
        </div>

        <div class="chart hide-breaks" id="chart">
            <% shifts.forEach(shift => { 
                const [startH, startM] = shift.start_time.split(':').map(Number);
                const [endH, endM] = shift.end_time.split(':').map(Number);

                let startPercent, endPercent;
                const totalMinutes = 24 * 60; // 1日の総分数

                if (shift.isFromYesterday) {
                    // 前日から継続している場合：0%から開始
                    startPercent = 0;
                    endPercent = ((endH * 60 + endM) / totalMinutes) * 100;
                } else {
                    // 当日開始の場合
                    startPercent = ((startH * 60 + startM) / totalMinutes) * 100;
                    
                    if (shift.end_time < shift.start_time) {
                        // 翌日に跨ぐ場合：100%まで表示
                        endPercent = 100;
                    } else {
                        endPercent = ((endH * 60 + endM) / totalMinutes) * 100;
                    }
                }
                const width = endPercent - startPercent;
                const durationHours = (endPercent - startPercent) * 24 / 100;
            %>
                <div class="row">
                    <div class="name-col"><%= shift.username %></div>
                    <div class="timeline">
                        <div class="bar" style="left: <%= startPercent %>%; width: <%= width %>%;">
                            <span style="padding-left: 5px;">
                                <%= shift.start_time %> 〜 <%= shift.end_time %>
                            </span>
                            
                            <% if (durationHours >= 6) { %>
                                <div class="break" style="
                                    position: absolute;
                                    top: 0;
                                    left: 40%; /* 仮に開始4時間後付近 */
                                    width: 10%; /* 約1時間分 */
                                    height: 100%;
                                    background: rgba(255,255,255,0.4);
                                    border-left: 1px dashed #fff;
                                    border-right: 1px dashed #fff;
                                "></div>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>

    <script>
        const btn = document.getElementById('breakToggle');
        const chart = document.getElementById('chart');

        btn.onclick = () => {
            const isHidden = chart.classList.toggle('hide-breaks');
            btn.innerText = isHidden ? '休憩を表示する' : '休憩を隠す';
        };
    </script>

    <style>
        /* 休憩表示の切り替え用CSS */
        .hide-breaks .break {
            display: none;
        }
        /* 目盛りの補助線 */
        .time-label::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 1px;
            height: 5px;
            background: #bbb;
        }
    </style>
</body>
</html>